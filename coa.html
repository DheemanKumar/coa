<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Computer Architecture & Organization Quiz</title>
</head>
<body>

<div class="container">
    <header>
        <h1>COA Master</h1>
        <p class="meta">10 Random Questions | Computer Architecture & Organization</p>
    </header>

    <div id="quiz-view">
        <div id="questions-container"></div>
        <div class="footer-actions">
            <button class="btn btn-primary" onclick="submitQuiz()">Submit Answers</button>
        </div>
    </div>

    <div id="result-view" class="result-view">
        <div class="score-board">
            <div>Your Score</div>
            <div class="score-val" id="final-score">0/10</div>
            <div id="score-comment">Good effort!</div>
        </div>
        <div id="results-summary"></div>
        <div class="footer-actions">
            <button class="btn btn-success" onclick="initQuiz()">Try Another 10 Questions</button>
        </div>
    </div>
</div>

<div id="toast">Question and options copied!</div>

<script src="questions/caching.js"></script>
<script src="questions/pipelining.js"></script>
<script>
    const allQuestions = [...cachingQuestions, ...pipeliningQuestions];
    let currentQuestions = [];

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    function initQuiz() {
        document.getElementById('quiz-view').style.display = 'block';
        document.getElementById('result-view').style.display = 'none';
        window.scrollTo(0,0);
        
        currentQuestions = shuffle([...allQuestions]).slice(0, 10);
        
        const container = document.getElementById('questions-container');
        container.innerHTML = '';

        currentQuestions.forEach((q, index) => {
            const block = document.createElement('div');
            block.className = 'question-block';
            block.id = `block-${index}`;

            let inputHTML = '';
            if (q.type === "Numerical") {
                inputHTML = `<input type="text" class="numerical-input" placeholder="Enter numerical value" data-idx="${index}">`;
            } else if (q.type === "Multiple Choice") {
                inputHTML = '<div class="options-grid">';
                for (let key in q.options) {
                    inputHTML += `
                        <label class="option-label">
                            <input type="radio" name="q-${index}" value="${key}" data-idx="${index}">
                            ${key}: ${q.options[key]}
                        </label>`;
                }
                inputHTML += '</div>';
            } else if (q.type === "Multiple Select") {
                inputHTML = '<div class="options-grid">';
                for (let key in q.options) {
                    inputHTML += `
                        <label class="option-label">
                            <input type="checkbox" name="q-${index}" value="${key}" data-idx="${index}">
                            ${key}: ${q.options[key]}
                        </label>`;
                }
                inputHTML += '</div>';
            }

            block.innerHTML = `
                <div class="question-header">
                    <div class="header-left">
                        <span class="meta">Question ${index + 1}</span>
                        <span class="topic-badge">${q.topic}</span>
                    </div>
                </div>
                <div class="question-text">${q.question}</div>
                ${inputHTML}
                <div id="feedback-${index}" class="feedback hidden"></div>
            `;
            container.appendChild(block);
        });
    }

    function submitQuiz() {
        let score = 0;
        const summary = document.getElementById('results-summary');
        summary.innerHTML = '';

        currentQuestions.forEach((q, index) => {
            let isCorrect = false;
            let userAnswer = "";

            if (q.type === "Numerical") {
                const input = document.querySelector(`input[data-idx="${index}"]`);
                userAnswer = input.value.trim().toLowerCase();
                isCorrect = userAnswer === q.correct_answer.toLowerCase();
            } else if (q.type === "Multiple Choice") {
                const selected = document.querySelector(`input[name="q-${index}"]:checked`);
                userAnswer = selected ? selected.value : "";
                isCorrect = userAnswer === q.correct_answer;
            } else if (q.type === "Multiple Select") {
                const checked = Array.from(document.querySelectorAll(`input[name="q-${index}"]:checked`)).map(el => el.value);
                userAnswer = checked;
                isCorrect = checked.length === q.correct_answer.length && 
                            checked.every(v => q.correct_answer.includes(v));
            }

            if (isCorrect) score++;

            const resultBlock = document.getElementById(`block-${index}`).cloneNode(true);
            const header = resultBlock.querySelector('.question-header');
            
            // Format Copy Text including Options
            let textToCopy = q.question;
            if (q.options && Object.keys(q.options).length > 0) {
                textToCopy += "\n\nOptions:";
                for (let key in q.options) {
                    textToCopy += `\n${key}: ${q.options[key]}`;
                }
            }
            textToCopy += `\n\nCorrect Answer: ${formatAnswer(q.correct_answer)}`;

            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copy Context
            `;
            copyBtn.onclick = () => copyToClipboard(textToCopy);
            header.appendChild(copyBtn);

            const feedback = resultBlock.querySelector('.feedback');
            feedback.classList.remove('hidden');
            
            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = `Correct! Your answer: ${formatAnswer(userAnswer)}`;
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `Incorrect. Your answer: ${formatAnswer(userAnswer)}
                    <span class="correct-answer-text">Correct Answer: ${formatAnswer(q.correct_answer)}</span>`;
            }
            
            summary.appendChild(resultBlock);
        });

        document.getElementById('final-score').innerText = `${score}/10`;
        
        let comment = "Keep practicing!";
        if (score === 10) comment = "Perfect! You are a master!";
        else if (score >= 8) comment = "Excellent understanding!";
        else if (score >= 5) comment = "Good effort, but room for improvement.";
        document.getElementById('score-comment').innerText = comment;

        document.getElementById('quiz-view').style.display = 'none';
        document.getElementById('result-view').style.display = 'block';
        window.scrollTo(0,0);
    }

    function formatAnswer(ans) {
        if (Array.isArray(ans)) return ans.sort().join(", ") || "None";
        return ans || "No answer";
    }

    function copyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showToast();
        } catch (err) {
            console.error('Unable to copy', err);
        }
        document.body.removeChild(textArea);
    }

    function showToast() {
        const toast = document.getElementById("toast");
        toast.className = "show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }

    window.onload = initQuiz;
</script>

</body>
</html>